---
title: "CONJ 620: Grades"
subtitle: "Most recent update: 2018-07-31"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: flatly
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(DT)
library(wesanderson)
sakai <- read_csv(here::here("data", "sakai.csv"))
dc <- read_csv(here::here("data", "dc.csv"))
```

Labs
===================================== 

Column {data-width=650}
-----------------------------------------------------------------------

### Labs (non-integrative)

Note: you'll be able to drop your 3 lowest labs- the grades below do not take that into account. 

```{r}
int_labs <- c("lab_06a", "lab_06b")
labs <- sakai %>% 
  filter(!lab %in% int_labs)
  
total_labs <- labs %>% 
  distinct(lab) %>% 
  tally() %>% 
  pull()

# drop 3 lowest
# to do later
labs_to_grade <- total_labs - 3
labs_keep <- labs %>% 
  arrange(fake_name, grade) %>% 
  group_by(fake_name) %>% 
  top_n(labs_to_grade) %>% 
  sample_n(labs_to_grade)

lab_grades <- labs %>% 
  count(fake_name, grade) %>% 
  spread(grade, n, fill = 0) %>% 
  select(fake_name, check_plus = `3`, check = `2`, 
         check_minus = `1`, miss_late = `0`) %>% 
  mutate(adj_plus = ifelse(check_plus - check_minus > 0, 
                           check_plus - check_minus,
                           0),
         adj_check = check + 2*(check_plus - adj_plus) + adj_plus,
         adj_minus = ifelse(check_minus - check_plus >= 0, 
                           check_minus - check_plus,
                           0),
         adj_ratio = ceiling(adj_check / adj_minus),
         adj_bounce = 2*floor((adj_plus / adj_check)*total_labs)) %>% 
  mutate(lab_grade = case_when(
    # pluses
    adj_plus == (.2*total_labs) & 
      adj_check == total_labs ~ 92,
    adj_plus == (.4*total_labs) & 
      adj_check == total_labs ~ 95,
    adj_plus > (.4*total_labs) & 
      adj_check == total_labs ~ 100,
    # solid = A
    adj_check == total_labs ~ 90,
    adj_check == .8*total_labs ~ 80 + adj_bounce,
    adj_check == .7*total_labs ~ 70 + adj_bounce,
    adj_check == .6*total_labs ~ 60 + adj_bounce,
    adj_check < .6*total_labs ~ 50 + adj_bounce,
    # if minuses remain
    adj_plus == 0 & adj_ratio >= 4 ~ 80,
    adj_plus == 0 & between(adj_ratio, 3, 3.9) ~ 70,
    adj_plus == 0 & between(adj_ratio, 2, 2.9) ~ 60,
    adj_plus == 0 & between(adj_ratio, 1, 1.9) ~ 50
  )) %>% 
  select(-starts_with("adj_"))
  
lab_grades %>% 
  datatable(rownames = FALSE,
            class = 'cell-border stripe',
            filter = list(position = 'top'),
            options = list(pageLength = nrow(lab_grades), 
                           autoWidth = TRUE,
                           bInfo = FALSE,
                           paging = FALSE),
            escape = FALSE)
```
  


Column {data-width=350}
-----------------------------------------------------------------------

### Grades by lab (raw)

```{r}
ggplot(labs, aes(x = lab, fill = as.factor(grade))) +
  geom_bar(position = "fill") +
  scale_fill_manual(values = wes_palette("Royal2")[c(1, 3:5)], 
                    name = "",
                    labels=c("missed/late", "minus", "check", "plus")) +
  labs(x = "", y = "percent of students") + 
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  theme(legend.position="bottom")
```

### Overall lab grades

```{r}
ggplot(lab_grades, aes(x = lab_grade)) +
  geom_histogram(colour = "white", binwidth = 5, fill = wes_palette("Royal2")[5]) +
  labs(x = "overall grade on lab portion") +
  theme_minimal() 
```



Integrative Labs
=====================================  


DataCamp
=====================================  

Column {data-width=800}
-----------------------------------------------------------------------

### DataCamp Courses Completed

```{r}
dc_out_of <- dc %>% 
  distinct(course) %>% 
  tally() %>% 
  pull()

# 80% of assignments on time get an A
# so far, all courses have had 4 chapters
dc %>% 
  count(fake_name, wt = completed) %>% 
  mutate(prop = (n / dc_out_of),
         dc_grade = case_when(
           between(prop, .9, 1) ~ 100,
           between(prop, .8, .89) ~ 90,
           between(prop, .7, .79) ~ 70,
           TRUE ~ 60
         )) %>% 
  datatable(rownames = FALSE,
            class = 'cell-border stripe',
            filter = list(position = 'top'),
            options = list(pageLength = nrow(dc), 
                           autoWidth = TRUE,
                           bInfo = FALSE,
                           paging = FALSE),
            escape = FALSE)
```